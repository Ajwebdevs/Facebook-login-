<!DOCTYPE html>
<html>
<head>
  <title>Facebook Login</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="/src/App.css">
</head>
<body>
<script>
  // This is called with the results from FB.getLoginStatus().
  function statusChangeCallback(response) {
    console.log('statusChangeCallback');
    console.log(response);  // The current login status of the person.
    if (response.status === 'connected') {
      testAPI();  
    } else {
      document.getElementById('status').innerHTML = 'Please log ' +
        'into this webpage.';
    }
  }

  // This function is called when someone finishes with the Login Button.
  function checkLoginState() {
    FB.getLoginStatus(function(response) {
      statusChangeCallback(response);
    });
  }

  window.fbAsyncInit = function() {
    FB.init({
      appId      : '994007258933295', 
      cookie     : true,       
      xfbml      : true,       
      version    : 'v20.0'     
    });

    FB.getLoginStatus(function(response) {
      statusChangeCallback(response);
    });
  };

  // Load the SDK asynchronously
  (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "https://connect.facebook.net/en_US/sdk.js";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));

  function testAPI() {
    console.log('Welcome! Fetching your information.... ');
    FB.api('/me', function(response) {
      console.log('Successful login for: ' + response.name);
      document.getElementById('status').innerHTML =
        'Thanks for logging in, ' + response.name + '!';
    });

    // Fetch the pages owned by the user
    FB.api('/me/accounts', function(response) {
      console.log('Pages:', response);
      if (response && !response.error) {
        const pages = response.data;
        let options = '<option value="">Select a page</option>';
        pages.forEach(page => {
          options += `<option value="${page.id}">${page.name}</option>`;
        });
        document.getElementById('pages').innerHTML = options;
      } else {
        console.error('Error fetching pages:', response.error);
      }
    });
  }

  // Function to fetch page insights
  function fetchPageInsights() {
    const pageId = document.getElementById('pages').value;
    if (!pageId) return;

    // Fetch page access token
    FB.api(`/me/accounts`, function(response) {
      const page = response.data.find(p => p.id === pageId);
      const accessToken = page.access_token;

      // Fetch page insights
      FB.api(`/${pageId}/insights`, {
        metric: 'page_fans,page_engaged_users,page_impressions,page_reactions_by_page',
        period: 'day',
        access_token: accessToken
      }, function(response) {
        console.log('Page Insights:', response);
        if (response && !response.error) {
          const insights = response.data;
          const findInsight = name => {
            const insight = insights.find(insight => insight.name === name);
            return insight ? insight.values[0].value : 'N/A';
          };
          document.getElementById('followers').innerText = findInsight('page_fans');
          document.getElementById('engagement').innerText = findInsight('page_engaged_users');
          document.getElementById('impressions').innerText = findInsight('page_impressions');
          document.getElementById('reactions').innerText = findInsight('page_reactions_by_page');
        } else {
          console.error('Error fetching insights:', response.error);
        }
      });
    });
  }
</script>

<!-- The JS SDK Login Button -->
<fb:login-button 
  scope="public_profile,pages_show_list,pages_read_engagement"
  onlogin="checkLoginState();">
</fb:login-button>

<div id="status"></div>

<h3>Owned Pages</h3>
<select id="pages" onchange="fetchPageInsights()">
</select>

<div>
  <h3>Page Insights</h3>
  <div>Total Followers: <span id="followers"></span></div>
  <div>Total Engagement: <span id="engagement"></span></div>
  <div>Total Impressions: <span id="impressions"></span></div>
  <div>Total Reactions: <span id="reactions"></span></div>
</div>

<!-- Load the JS SDK asynchronously -->
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>
</body>
</html>
